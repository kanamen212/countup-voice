<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Count-Up (8R) — タップ専用ライト版（Enter/確定で進む）</title>
<style>
  :root { --gap: 10px; --radius: 12px; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, system-ui, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif; margin:0; padding:16px; background:#f7f7f7; color:#111; }
  header { margin-bottom:12px; }
  h1 { font-size:1.25rem; margin:0 0 6px; }
  .sub { color:#555; font-size:.95rem; }
  .card { background:#fff; border-radius:12px; padding:14px; box-shadow:0 1px 4px rgba(0,0,0,.06); margin-bottom:12px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .pill { display:inline-block; padding:4px 10px; background:#efefef; border-radius:999px; font-size:.9rem; }
  button { padding:12px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; font-size:1rem; }
  button.primary { background:#222; color:#fff; border-color:#222; }
  button.warn { background:#fff0f0; border-color:#f3b8b8; color:#a40000; }
  .rounds { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
  .round { border:1px solid #eee; border-radius:10px; padding:10px; background:#fafafa; }
  .round h3 { margin:0 0 8px; font-size:1rem; }
  .round .ctrl { display:flex; gap:8px; align-items:center; }
  .round input { flex:1 1 auto; padding:10px; font-size:1.1rem; border:1px solid #ccc; border-radius:8px; }
  .hint { color:#666; font-size:.9rem; }
  .big { font-size:1.05rem; }
  .stats { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
  .stat { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px; }
  .list table { width:100%; border-collapse:collapse; }
  .list th, .list td { text-align:right; padding:8px; border-bottom:1px solid #eee; }
  .list th:first-child, .list td:first-child { text-align:left; }
  .pad { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px; }
  .pad button { padding:14px 10px; border-radius:12px; font-size:1.1rem; }
  .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .chip { padding:8px 10px; border:1px solid #ddd; border-radius:999px; background:#fafafa; }
</style>
</head>
<body>
<header>
  <h1>Count-Up (8R)</h1>
  <div class="sub">タップ/数値入力のみ。<b>Enter</b>か<b>「確定」</b>で次ラウンドへ。</div>
</header>

<section class="card">
  <div class="row">
    <button id="finishBtn" class="primary">ゲームを確定</button>
    <button id="undoBtn">直前ラウンド取消</button>
  </div>
</section>

<section class="card">
  <h2 style="margin:0 0 10px;">現在のゲーム</h2>
  <div class="row">
    <div class="pill">R <span id="currentRound">1</span> / 8</div>
    <div class="pill">合計: <span id="runningTotal">0</span></div>
    <div class="pill">平均/ラウンド: <span id="runningAvg">0.0</span></div>
  </div>
  <div class="rounds" id="rounds"></div>

  <div class="hint big" style="margin-top:8px;">■ 大型ナンバーパッド（片手操作）</div>
  <div class="pad" id="pad">
    <button data-val="20">20</button>
    <button data-val="40">40</button>
    <button data-val="60">60</button>
    <button data-val="80">80</button>
    <button data-val="100">100</button>
    <button data-val="120">120</button>
    <button data-val="140">140</button>
    <button data-val="160">160</button>
    <button data-val="180">180</button>
  </div>
  <div class="chips">
    <span class="chip" data-val="0">ミス/ゼロ</span>
    <span class="chip" data-val="25">25（S-BULL）</span>
    <span class="chip" data-val="50">50（D-BULL）</span>
    <span class="chip" data-step="-5">−5</span>
    <span class="chip" data-step="5">＋5</span>
    <span class="chip" id="skipChip">スキップ</span>
  </div>
</section>

<section class="card">
  <h2 style="margin:0 10px 10px 0;">履歴 & 生涯成績</h2>
  <div class="stats" style="margin-bottom:8px;">
    <div class="stat">総ゲーム数: <strong id="gamesCount">0</strong></div>
    <div class="stat">生涯平均 (/R): <strong id="careerAvg">0.0</strong></div>
    <div class="stat">ベスト (合計): <strong id="bestTotal">0</strong></div>
    <div class="stat">直近5ゲーム平均 (合計): <strong id="last5Avg">0.0</strong></div>
  </div>
  <div class="row">
    <button id="exportCsvBtn">CSVエクスポート</button>
    <button id="clearHistoryBtn" class="warn">履歴を全消去</button>
  </div>
  <div class="list" style="margin-top:10px;">
    <table id="historyTable">
      <thead>
        <tr>
          <th>日時</th>
          <th>R1</th><th>R2</th><th>R3</th><th>R4</th>
          <th>R5</th><th>R6</th><th>R7</th><th>R8</th>
          <th>合計</th><th>平均/R</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script>
(function(){
  const ROUNDS = 8;
  const roundsEl = document.getElementById('rounds');
  const runningTotalEl = document.getElementById('runningTotal');
  const runningAvgEl = document.getElementById('runningAvg');
  const currentRoundEl = document.getElementById('currentRound');
  const finishBtn = document.getElementById('finishBtn');
  const undoBtn = document.getElementById('undoBtn');
  const gamesCountEl = document.getElementById('gamesCount');
  const careerAvgEl = document.getElementById('careerAvg');
  const bestTotalEl = document.getElementById('bestTotal');
  const last5AvgEl = document.getElementById('last5Avg');
  const historyTableBody = document.querySelector('#historyTable tbody');

  let current = { scores: Array(ROUNDS).fill(null), idx: 0 };

  function extractScore(text){
    if(text==null) return null;
    const t = String(text).trim();
    const m = t.match(/-?\d+/);
    if(m) return parseInt(m[0],10);
    const map = { 'ミス':0, 'ゼロ':0, 'シングルブル':25, 'ダブルブル':50, 'ブル':50 };
    for(const k in map){ if(t.includes(k)) return map[k]; }
    return null;
  }

  function updateUI(){
    currentRoundEl.textContent = (current.idx + 1);
    roundsEl.innerHTML = '';
    for(let i=0;i<ROUNDS;i++){
      const val = current.scores[i];
      const div = document.createElement('div');
      div.className = 'round';
      div.innerHTML = `
        <h3>R${i+1}</h3>
        <div class="ctrl">
          <input data-round="${i}" type="number" inputmode="numeric" min="0" max="180" step="1" placeholder="0〜180" value="${val!==null?val:''}">
          <button class="confirm" data-round="${i}">確定</button>
        </div>
      `;
      roundsEl.appendChild(div);
    }
    const filled = current.scores.filter(v => typeof v === 'number');
    const total = filled.reduce((a,b)=>a+b,0);
    runningTotalEl.textContent = total;
    runningAvgEl.textContent = filled.length ? (total/filled.length).toFixed(1) : '0.0';
    const cur = roundsEl.querySelector(`input[data-round="${current.idx}"]`);
    if(cur){ cur.focus(); setTimeout(()=>{ cur.selectionStart = cur.value.length; cur.selectionEnd = cur.value.length; }, 0); }
    finishBtn.disabled = filled.length !== ROUNDS;
  }

  function setRoundValue(r, value){
    const v = Math.max(0, Math.min(180, Number(value)||0));
    current.scores[r] = v;
    // 自動で次へ
    current.idx = Math.min(ROUNDS, r+1);
    renderRunning();
    updateUI();
  }

  function renderRunning(){
    const filled = current.scores.filter(n=>typeof n==='number');
    const total = filled.reduce((a,b)=>a+b,0);
    runningTotalEl.textContent = total;
    runningAvgEl.textContent = filled.length ? (total/filled.length).toFixed(1) : '0.0';
  }

  function renderHistory(){
    const hist = loadHistory();
    gamesCountEl.textContent = hist.length;
    historyTableBody.innerHTML='';
    for(let i=hist.length-1;i>=0;i--){
      const g = hist[i]; const tr=document.createElement('tr');
      const dts = new Date(g.date).toLocaleString();
      const cells=[dts, ...g.rounds.map(v=>v??''), g.total, (g.total/ROUNDS).toFixed(1)];
      for(const c of cells){ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }
      historyTableBody.appendChild(tr);
    }
    const rounds = hist.flatMap(h=>h.rounds).filter(v=>typeof v==='number');
    const career = rounds.length? (rounds.reduce((a,b)=>a+b,0)/rounds.length):0;
    careerAvgEl.textContent = career.toFixed(1);
    bestTotalEl.textContent = hist.reduce((m,g)=>Math.max(m,g.total),0);
    const last5 = hist.slice(-5).map(g=>g.total);
    const last5Avg = last5.length? last5.reduce((a,b)=>a+b,0)/last5.length : 0;
    last5AvgEl.textContent = last5Avg.toFixed(1);
  }

  function saveGame(){
    const filled = current.scores.filter(v => typeof v === 'number');
    if(filled.length !== ROUNDS){ alert('8ラウンドすべて入力してください。'); return; }
    const total = filled.reduce((a,b)=>a+b,0);
    const avg = total/ROUNDS;
    const hist = loadHistory();
    hist.push({ date: new Date().toISOString(), rounds: current.scores.slice(), total, avg });
    localStorage.setItem('countupHistory', JSON.stringify(hist));
    renderHistory();
    current = { scores:Array(ROUNDS).fill(null), idx:0 };
    updateUI();
  }

  function loadHistory(){ try{ return JSON.parse(localStorage.getItem('countupHistory'))||[]; }catch(e){ return []; } }
  function exportCsv(){
    const hist = loadHistory();
    const header = ['date','R1','R2','R3','R4','R5','R6','R7','R8','total','avg'];
    const lines = [header.join(',')];
    for(const g of hist){
      const row=[g.date, ...g.rounds.map(v=>v??''), g.total, (g.total/8).toFixed(1)];
      lines.push(row.join(','));
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='countup_history.csv'; a.click(); URL.revokeObjectURL(url);
  }
  function clearHistory(){ if(confirm('履歴をすべて消去します。よろしいですか？')){ localStorage.removeItem('countupHistory'); renderHistory(); } }
  function undo(){
    for(let i=ROUNDS-1;i>=0;i--){
      if(typeof current.scores[i]==='number'){ current.scores[i]=null; current.idx=i; updateUI(); return; }
    }
  }

  // 入力欄：Enterで確定
  roundsEl.addEventListener('keydown', (e)=>{
    const target = e.target;
    if(!target || !target.matches('input[data-round]')) return;
    if(e.key === 'Enter'){
      e.preventDefault();
      const r = parseInt(target.dataset.round,10);
      setRoundValue(r, target.value);
    }
  });
  // 入力欄：確定ボタンで確定
  roundsEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('button.confirm'); if(!btn) return;
    const r = parseInt(btn.dataset.round,10);
    const input = roundsEl.querySelector(`input[data-round="${r}"]`);
    setRoundValue(r, input ? input.value : 0);
  });

  // ナンバーパッド／チップ（押したら即確定→次へ）
  document.getElementById('pad').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-val]'); if(!btn) return;
    setRoundValue(current.idx, parseInt(btn.dataset.val,10));
  });
  document.querySelector('.chips').addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    if(chip.id==='skipChip'){ current.idx = Math.min(ROUNDS, current.idx+1); updateUI(); return; }
    if(chip.dataset.val){ setRoundValue(current.idx, parseInt(chip.dataset.val,10)); return; }
    if(chip.dataset.step){
      const cur = current.scores[current.idx] ?? 0;
      const next = Math.max(0, Math.min(180, cur + parseInt(chip.dataset.step,10)));
      setRoundValue(current.idx, next);
    }
  });

  // 上部ボタン
  document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
  document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
  document.getElementById('finishBtn').addEventListener('click', saveGame);
  document.getElementById('undoBtn').addEventListener('click', undo);

  // 初期化
  renderHistory();
  updateUI();
})();
</script>
</body>
</html>
