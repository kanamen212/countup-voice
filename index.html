<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Count-Up Dictation Scorer (iOS向け・8R, 🎤優先)</title>
<style>
  :root { --gap: 10px; --radius: 12px; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, system-ui, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
    margin: 0; padding: 16px; background: #f7f7f7; color: #111; }
  header { margin-bottom: 12px; }
  h1 { font-size: 1.25rem; margin: 0 0 6px; }
  .sub { color: #555; font-size: 0.95rem; }
  .card { background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,.06); margin-bottom: 12px; }
  .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .pill { display: inline-block; padding: 4px 10px; background: #efefef; border-radius: 999px; font-size: .9rem; }
  button { padding: 12px 14px; border-radius: 10px; border: 1px solid #ddd; background: #fff; font-size: 1rem; }
  button.primary { background: #222; color: #fff; border-color: #222; }
  button.warn { background: #fff0f0; border-color: #f3b8b8; color: #a40000; }
  .rounds { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
  .round { border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fafafa; }
  .round h3 { margin: 0 0 8px; font-size: 1rem; }
  .round input { width: 100%; padding: 10px; font-size: 1.1rem; border: 1px solid #ccc; border-radius: 8px; }
  .hint { color: #666; font-size: .9rem; }
  .big { font-size: 1.05rem; }
  .stats { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
  .stat { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 10px; }
  .list table { width: 100%; border-collapse: collapse; }
  .list th, .list td { text-align: right; padding: 8px; border-bottom: 1px solid #eee; }
  .list th:first-child, .list td:first-child { text-align: left; }
</style>
</head>
<body>
<header>
  <h1>Count-Up Dictation Scorer (8R)</h1>
  <div class="sub">iOSの<strong>キーボード音声入力（🎤）</strong>で数値を話すと、<strong>自動で次ラウンドに進む</strong>版です。マイク許可は不要。</div>
</header>

<section class="card">
  <div class="row">
    <button id="focusBtn" class="primary">🎤 開始（現在ラウンドにフォーカス）</button>
    <button id="finishBtn" class="">ゲームを確定</button>
    <button id="undoBtn" class="">直前ラウンド取消</button>
    <div class="pill">TTS: <span id="ttsStatus">ON</span></div>
    <button id="toggleTTS">読み上げ ON/OFF</button>
  </div>
  <div class="hint">話し方例: <span class="pill">140</span> <span class="pill">100点</span> <span class="pill">ミス</span> <span class="pill">ゼロ</span> <span class="pill">シングルブル</span> <span class="pill">ダブルブル</span></div>
</section>

<section class="card">
  <h2 style="margin:0 0 10px;">現在のゲーム</h2>
  <div class="row">
    <div class="pill">R <span id="currentRound">1</span> / 8</div>
    <div class="pill">合計: <span id="runningTotal">0</span></div>
    <div class="pill">平均/ラウンド: <span id="runningAvg">0.0</span></div>
  </div>
  <div class="rounds" id="rounds"></div>
  <div class="hint big">※「開始」を1回押して、ソフトキーボードの🎤で数字を話す → 自動で次ラウンドにフォーカスされます（手でタップしなくてOK）。</div>
</section>

<section class="card">
  <h2 style="margin:0 10px 10px 0;">履歴 & 生涯成績</h2>
  <div class="stats" style="margin-bottom:8px;">
    <div class="stat">総ゲーム数: <strong id="gamesCount">0</strong></div>
    <div class="stat">生涯平均 (/R): <strong id="careerAvg">0.0</strong></div>
    <div class="stat">ベスト (合計): <strong id="bestTotal">0</strong></div>
    <div class="stat">直近5ゲーム平均 (合計): <strong id="last5Avg">0.0</strong></div>
  </div>
  <div class="row">
    <button id="exportCsvBtn">CSVエクスポート</button>
    <button id="clearHistoryBtn" class="warn">履歴を全消去</button>
  </div>
  <div class="list" style="margin-top:10px;">
    <table id="historyTable">
      <thead>
        <tr>
          <th>日時</th>
          <th>R1</th><th>R2</th><th>R3</th><th>R4</th>
          <th>R5</th><th>R6</th><th>R7</th><th>R8</th>
          <th>合計</th><th>平均/R</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script>
(function(){
  const ROUNDS = 8;
  const roundsEl = document.getElementById('rounds');
  const runningTotalEl = document.getElementById('runningTotal');
  const runningAvgEl = document.getElementById('runningAvg');
  const currentRoundEl = document.getElementById('currentRound');
  const finishBtn = document.getElementById('finishBtn');
  const undoBtn = document.getElementById('undoBtn');
  const focusBtn = document.getElementById('focusBtn');
  const toggleTTSBtn = document.getElementById('toggleTTS');
  const ttsStatusEl = document.getElementById('ttsStatus');
  const gamesCountEl = document.getElementById('gamesCount');
  const careerAvgEl = document.getElementById('careerAvg');
  const bestTotalEl = document.getElementById('bestTotal');
  const last5AvgEl = document.getElementById('last5Avg');
  const historyTableBody = document.querySelector('#historyTable tbody');

  let current = { scores: Array(ROUNDS).fill(null), idx: 0 };
  let ttsEnabled = true;

  function speak(text){
    if(!ttsEnabled) return;
    try { const u = new SpeechSynthesisUtterance(text); u.lang='ja-JP'; speechSynthesis.speak(u); } catch(e){}
  }

  function extractScore(text){
    if(!text) return null;
    const t = String(text).trim();
    const numMatch = t.replace(/、/g,' ').match(/-?\d+/);
    if(numMatch){ return parseInt(numMatch[0],10); }
    const map = { 'ミス':0, 'ノー':0, 'ゼロ':0, 'シングルブル':25, 'ダブルブル':50, 'ブル':50 };
    for(const k in map){ if(t.includes(k)) return map[k]; }
    return null;
  }

  function updateUI(){
    currentRoundEl.textContent = (current.idx + 1);
    roundsEl.innerHTML = '';
    for(let i=0;i<ROUNDS;i++){
      const val = current.scores[i];
      const div = document.createElement('div');
      div.className = 'round';
      /* 🎤優先: inputmodeを付けず、type="text" のみ */
      div.innerHTML = `
        <h3>R${i+1}</h3>
        <input data-round="${i}" type="text" placeholder="ここに音声入力/手入力（0〜180）" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" value="${val!==null?val:''}">
      `;
      roundsEl.appendChild(div);
    }
    const filled = current.scores.filter(v => typeof v === 'number');
    const total = filled.reduce((a,b)=>a+b,0);
    runningTotalEl.textContent = total;
    runningAvgEl.textContent = filled.length ? (total/filled.length).toFixed(1) : '0.0';
    finishBtn.disabled = filled.length !== ROUNDS;
    const curInput = roundsEl.querySelector(`input[data-round="${current.idx}"]`);
    if(curInput){ curInput.focus(); setTimeout(()=>{ curInput.selectionStart = curInput.value.length; curInput.selectionEnd = curInput.value.length; }, 0); }
  }

  function setRoundValueFromText(r, text){
    const score = extractScore(text);
    if(score===null || isNaN(score)) return false;
    const clamped = Math.max(0, Math.min(180, score));
    current.scores[r] = clamped;
    const total = current.scores.filter(v=>typeof v==='number').reduce((a,b)=>a+b,0);
    speak(`ラウンド${r+1}、${clamped}点。合計 ${total} 点。`);
    return true;
  }

  function tryAdvance(){
    const r = current.idx;
    const input = roundsEl.querySelector(`input[data-round="${r}"]`);
    if(!input) return;
    if(setRoundValueFromText(r, input.value)){
      current.idx = Math.min(ROUNDS, r+1);
      updateUI();
    }
  }

  function renderHistory(){
    const hist = loadHistory();
    gamesCountEl.textContent = hist.length;
    historyTableBody.innerHTML='';
    for(let i=hist.length-1;i>=0;i--){
      const g = hist[i]; const tr=document.createElement('tr');
      const dts = new Date(g.date).toLocaleString();
      const cells=[dts, ...g.rounds.map(v=>v??''), g.total, (g.total/ROUNDS).toFixed(1)];
      for(const c of cells){ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }
      historyTableBody.appendChild(tr);
    }
    const rounds = hist.flatMap(h=>h.rounds).filter(v=>typeof v==='number');
    const career = rounds.length? (rounds.reduce((a,b)=>a+b,0)/rounds.length):0;
    careerAvgEl.textContent = career.toFixed(1);
    bestTotalEl.textContent = hist.reduce((m,g)=>Math.max(m,g.total),0);
    const last5 = hist.slice(-5).map(g=>g.total);
    const last5Avg = last5.length? last5.reduce((a,b)=>a+b,0)/last5.length : 0;
    last5AvgEl.textContent = last5Avg.toFixed(1);
  }

  function saveGame(){
    const filled = current.scores.filter(v => typeof v === 'number');
    if(filled.length !== ROUNDS){ alert('8ラウンドすべて入力してください。'); return; }
    const total = filled.reduce((a,b)=>a+b,0);
    const avg = total/ROUNDS;
    const hist = loadHistory();
    hist.push({ date: new Date().toISOString(), rounds: current.scores.slice(), total, avg });
    localStorage.setItem('countupHistory', JSON.stringify(hist));
    speak(`保存しました。合計 ${total} 点、平均 ${avg.toFixed(1)} 点です。`);
    renderHistory();
    current = { scores:Array(ROUNDS).fill(null), idx:0 };
    updateUI();
  }

  function loadHistory(){ try{ return JSON.parse(localStorage.getItem('countupHistory'))||[]; }catch(e){ return []; } }
  function exportCsv(){
    const hist = loadHistory();
    const header = ['date','R1','R2','R3','R4','R5','R6','R7','R8','total','avg'];
    const lines = [header.join(',')];
    for(const g of hist){
      const row=[g.date, ...g.rounds.map(v=>v??''), g.total, (g.total/8).toFixed(1)];
      lines.push(row.join(','));
    }
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='countup_history.csv'; a.click(); URL.revokeObjectURL(url);
  }
  function clearHistory(){ if(confirm('履歴をすべて消去します。よろしいですか？')){ localStorage.removeItem('countupHistory'); renderHistory(); } }
  function undo(){
    for(let i=ROUNDS-1;i>=0;i--){
      if(typeof current.scores[i]==='number'){ current.scores[i]=null; current.idx=i; updateUI(); speak(`ラウンド${i+1}を取り消しました。`); return; }
    }
    speak('取り消すスコアがありません。');
  }

  roundsEl.addEventListener('input', (e)=>{
    const target = e.target;
    if(target && target.matches('input[data-round]')){
      const v = target.value;
      if(/[ \n　]/.test(v) || /^\d{1,3}$/.test(v)){ tryAdvance(); }
    }
  });
  roundsEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); tryAdvance(); }
  });

  document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
  document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
  focusBtn.addEventListener('click', ()=>{
    const cur = roundsEl.querySelector(`input[data-round="${current.idx}"]`);
    if(cur){ cur.focus(); cur.select(); }
  });
  finishBtn.addEventListener('click', saveGame);
  undoBtn.addEventListener('click', undo);
  toggleTTSBtn.addEventListener('click', ()=>{ ttsEnabled=!ttsEnabled; ttsStatusEl.textContent = ttsEnabled?'ON':'OFF'; });

  renderHistory();
  updateUI();
})();
</script>
</body>
</html>
